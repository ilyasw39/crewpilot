<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schedule - CrewPilot</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
      :root {
        --primary: #00adb5;
        --primary-light: #eef2ff;
        --background: #ffffff;
        --text: #111827;
        --gray: #6b7280;
        --radius: 14px;
        font-size: 16px;
      }
      body.dark {
        --background: #1e1e2f;
        --text: #f3f4f6;
        --gray: #9ca3af;
        --primary-light: #2c2e3a;
      }
      body.dark .fc {
        --fc-page-bg-color: #1e1e2f;
        --fc-neutral-bg-color: #2c2e3a;
        --fc-neutral-text-color: #e5e7eb;
        --fc-border-color: #3f3f46;
        --fc-button-bg-color: #00adb5;
        --fc-button-text-color: white;
        --fc-button-hover-bg-color: #009aa4;
        --fc-event-bg-color: #00adb5;
        --fc-event-border-color: #009aa4;
        --fc-event-text-color: #ffffff;
      }
      body.dark #calendar {
        background: #1e1e2f !important;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background);
        color: var(--text);
        min-height: 100vh;
        transition: background 0.3s ease, color 0.3s ease;
        position: relative;
        overflow-x: hidden;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-image: linear-gradient(
            to right,
            rgba(0, 0, 0, 0.08) 2px,
            transparent 2px
          ),
          linear-gradient(to bottom, rgba(0, 0, 0, 0.08) 2px, transparent 2px);
        background-size: 140px 140px;
        z-index: -1;
      }
      header {
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--primary-light);
        border-bottom: 1px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .logo img {
        max-height: 42px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .logo:hover img {
        transform: scale(1.05);
      }
      nav {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      nav a {
        text-decoration: none;
        font-weight: 600;
        color: var(--text);
        transition: color 0.2s ease;
        position: relative;
        padding: 0.5rem 0;
      }
      nav a:hover {
        color: var(--primary);
      }
      nav a::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: var(--primary);
        transition: width 0.3s ease;
      }
      nav a:hover::after {
        width: 100%;
      }
      .logout {
        background: var(--primary);
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: var(--radius);
        transition: background 0.3s ease, transform 0.2s ease;
      }
      .logout:hover {
        background: #008a91;
        transform: translateY(-2px);
      }
      .settings-toggle button {
        background: none;
        border: none;
        font-size: 1.3rem;
        color: var(--text);
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .settings-toggle button:hover {
        transform: rotate(180deg);
      }
      .settings-panel {
        position: fixed;
        top: 70px;
        right: 20px;
        background: var(--primary-light);
        padding: 1rem;
        border-radius: var(--radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        gap: 0.8rem;
        z-index: 20;
        min-width: 200px;
      }
      .settings-panel label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }
      .settings-panel input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      .settings-panel.active {
        display: flex;
      }
      main {
        padding: 2rem;
        max-width: 1200px;
        margin: auto;
      }
      h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1.2rem;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .top-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        gap: 1rem;
      }

      .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .assign-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      #assignEmpSelect {
        padding: 0.6rem;
        border-radius: var(--radius);
        border: 1px solid #e5e7eb;
        background: white;
        min-width: 200px;
        font-size: 0.95rem;
      }

      body.dark #assignEmpSelect {
        background: #2c2e3a;
        color: #f3f4f6;
        border-color: #3f3f46;
      }

      #calendar {
        background: white;
        padding: 1.5rem;
        border-radius: var(--radius);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        min-height: 700px;
        margin-bottom: 2rem;
      }

      body.dark #calendar {
        background: #1e1e2f;
      }

      .weekly-hours {
        background: var(--primary-light);
        padding: 1.5rem 2rem;
        border-radius: var(--radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      }

      .hours-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .hours-header > div:first-child {
        flex: 1;
      }

      .hours-header > div:last-child {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }

      .hours-total {
        font-weight: 600;
        color: var(--gray);
      }

      #hoursPeriod {
        font-size: 0.95rem;
        color: var(--gray);
        margin-top: 0.25rem;
      }

      .hours-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
      }

      .hours-count {
        font-weight: 600;
        color: var(--gray);
        font-size: 0.95rem;
      }

      .hours-search {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--background);
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        border: 1px solid #e5e7eb;
        min-width: 250px;
      }

      .hours-search i {
        color: var(--gray);
      }

      .hours-search input {
        border: none;
        background: transparent;
        width: 100%;
        font-size: 0.95rem;
        color: var(--text);
      }

      .hours-search input:focus {
        outline: none;
      }

      #weeklyHoursList {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      #weeklyHoursList li {
        padding: 0.8rem 1.2rem;
        background-color: var(--background);
        margin-bottom: 0.6rem;
        border-radius: var(--radius);
        font-weight: 500;
        color: var(--text);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      body.dark #weeklyHoursList li {
        background-color: #2c2e3a;
        color: #f3f4f6;
      }

      .button {
        background: var(--primary);
        color: white;
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: var(--radius);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .button:hover {
        background: #007b80;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .button i {
        font-size: 0.9em;
      }

      .ball-decoration {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 30% 30%,
          var(--primary),
          var(--gray)
        );
        opacity: 0.15;
        z-index: -1;
        animation: float 8s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(5deg);
        }
      }

      .success-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4caf50;
        color: white;
        padding: 1rem 2rem;
        border-radius: var(--radius);
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        animation: fadeInOut 3s ease-in-out forwards;
      }

      .error-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #dc2626;
        color: white;
        padding: 1rem 2rem;
        border-radius: var(--radius);
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        animation: fadeInOut 3s ease-in-out forwards;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          top: 0;
        }
        10% {
          opacity: 1;
          top: 20px;
        }
        90% {
          opacity: 1;
          top: 20px;
        }
        100% {
          opacity: 0;
          top: 0;
        }
      }

      .no-hours {
        text-align: center;
        padding: 2rem;
        color: var(--gray);
      }

      .no-hours i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #d1d5db;
      }

      .close-popup {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray);
        cursor: pointer;
        transition: color 0.2s;
      }

      .close-popup:hover {
        color: var(--primary);
      }

      .visible-rows-count {
        font-weight: normal;
        color: var(--gray);
        font-size: 0.9em;
      }

      .keyboard-shortcuts {
        background: var(--primary-light);
        padding: 1.5rem;
        border-radius: var(--radius);
        margin-top: 2rem;
      }

      .keyboard-shortcuts h3 {
        margin-bottom: 1rem;
        font-size: 1.2rem;
        color: var(--primary);
      }

      .keyboard-shortcuts ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      }

      .keyboard-shortcuts li {
        padding: 0.8rem;
        background: var(--background);
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }

      .keyboard-shortcuts kbd {
        background: var(--primary-light);
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-family: monospace;
        font-weight: bold;
      }

      .template-modal input[type="text"],
      .template-modal select,
      .template-modal input[type="time"] {
        width: 100%;
        padding: 0.6rem;
        margin-bottom: 1rem;
        border-radius: var(--radius);
        border: 1px solid #e5e7eb;
        background: var(--background);
        color: var(--text);
      }

      .template-modal label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .shift-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .shift-time {
        flex: 1;
      }

      .shift-type {
        flex: 1;
      }

      .button.small {
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
      }

      .button.delete {
        background: #dc2626;
      }

      /* Modal styles */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-backdrop.active {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: var(--background);
        padding: 2rem;
        border-radius: var(--radius);
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        position: relative;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      .modal-backdrop.active .modal-content {
        transform: translateY(0);
      }

      .button.whatsapp {
        background-color: #25d366;
      }
      .button.whatsapp:hover {
        background-color: #128c7e;
      }
    </style>
  </head>
  <body>
    <!-- Ball Decorations -->
    <div id="ballContainer">
      <div class="ball-decoration" style="top: 10%; left: 5%"></div>
      <div
        class="ball-decoration"
        style="top: 60%; right: 8%; width: 80px; height: 80px"
      ></div>
      <div
        class="ball-decoration"
        style="bottom: 15%; left: 15%; width: 60px; height: 60px"
      ></div>
      <div
        class="ball-decoration"
        style="bottom: 5%; right: 20%; width: 120px; height: 120px"
      ></div>
      <div
        class="ball-decoration"
        style="top: 30%; left: 40%; width: 70px; height: 70px"
      ></div>
      <div
        class="ball-decoration"
        style="top: 10%; right: 10%; width: 90px; height: 90px"
      ></div>
      <div
        class="ball-decoration"
        style="bottom: 20%; left: 30%; width: 110px; height: 110px"
      ></div>
      <div
        class="ball-decoration"
        style="bottom: 10%; right: 5%; width: 50px; height: 50px"
      ></div>
      <div
        class="ball-decoration"
        style="top: 50%; left: 10%; width: 110px; height: 110px"
      ></div>
    </div>

    <header>
      <div class="logo" onclick="location.href='index.html'">
        <img src="images/plane_blue_nobg.png" alt="CrewPilot Logo" />
      </div>
      <nav>
        <a onclick="logout()" class="logout"
          ><i class="fas fa-sign-out-alt"></i> Logout</a
        >
        <a href="schedule.html" style="color: var(--primary)"
          ><i class="fas fa-calendar-alt"></i> Schedule</a
        >
        <a href="team.html"><i class="fas fa-users"></i> Team</a>
        <div class="settings-toggle">
          <button onclick="toggleSettings()">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </nav>
    </header>

    <div class="settings-panel" id="settingsPanel">
      <label
        ><input type="checkbox" id="darkModeToggle" onchange="toggleTheme()" />
        Dark Mode</label
      >
      <label>
        <input type="checkbox" id="ballsToggle" onchange="toggleBalls()" />
        Floating Balls
      </label>
    </div>

    <main>
      <!-- Page Title -->
      <h1><i class="fas fa-calendar-alt"></i> Schedule</h1>
      <p style="margin-bottom: 1.5rem; color: var(--gray)">
        Plan, assign, and track employee shifts
      </p>

      <!-- Top Controls -->
      <div class="top-controls">
        <div class="button-group">
          <button class="button" onclick="showModal('templateManagerModal')">
            <i class="fas fa-copy"></i> Template Manager
          </button>
          <button class="button" onclick="generateSchedule()">
            <i class="fas fa-magic"></i> Generate Schedule
          </button>
          <button class="button whatsapp" onclick="sendScheduleToWhatsApp()">
            <i class="fab fa-whatsapp"></i> Share via WhatsApp
          </button>
        </div>
        <div class="assign-controls">
          <select id="assignEmpSelect" class="select">
            <option value="">Select Employee</option>
          </select>
          <button class="button" onclick="assignShift()">
            <i class="fas fa-user-plus"></i> Assign Shift
          </button>
        </div>
      </div>

      <!-- Calendar Section -->
      <div id="calendar"></div>

      <!-- Weekly Hours Section -->
      <div class="weekly-hours">
        <div class="hours-header">
          <div>
            <h2 id="hoursTitle">Weekly Hours</h2>
            <div id="hoursPeriod"></div>
          </div>
          <div>
            <div class="hours-total" id="hoursTotal">Total: 0 hours</div>
            <div class="hours-count" id="hoursCount">Showing 0 employees</div>
            <div class="hours-search">
              <i class="fas fa-search"></i>
              <input
                type="text"
                id="hoursSearchInput"
                placeholder="Search by name..."
                oninput="filterHoursList()"
              />
            </div>
          </div>
        </div>
        <ul id="weeklyHoursList"></ul>
        <div id="noHoursMessage" class="no-hours" style="display: none">
          <i class="fas fa-users-slash"></i>
          <h3>No Hours Recorded</h3>
          <p>Assign shifts to see employee hours</p>
        </div>
      </div>

      <!-- Keyboard Shortcuts Section -->
      <div class="keyboard-shortcuts">
        <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
        <ul>
          <li><kbd>Click</kbd> Select a shift</li>
          <li><kbd>Click + Drag</kbd> Select multiple shifts</li>
          <li><kbd>Delete</kbd> Remove selected shift</li>
          <li><kbd>D</kbd> Duplicate selected shift</li>
          <li><kbd>R</kbd> Reassign selected shift</li>
        </ul>
      </div>
    </main>

    <!-- Template Manager Modal -->
    <div class="modal-backdrop" id="templateManagerModal">
      <div class="modal-content template-modal">
        <button class="close-popup" onclick="hideModal('templateManagerModal')">
          <i class="fas fa-times"></i>
        </button>
        <h2><i class="fas fa-copy"></i> Template Manager</h2>

        <div style="margin-bottom: 1.5rem">
          <h3><i class="fas fa-list"></i> Saved Templates</h3>
          <select id="templateSelect" class="select">
            <option value="">Select a template</option>
          </select>
        </div>

        <div class="button-group">
          <button class="button" onclick="loadTemplate()">
            <i class="fas fa-upload"></i> Load Template
          </button>
          <button class="button" onclick="openEditTemplateModal()">
            <i class="fas fa-edit"></i> Edit Template
          </button>
          <button class="button delete" onclick="deleteTemplate()">
            <i class="fas fa-trash"></i> Delete Template
          </button>
        </div>

        <div style="text-align: center; margin: 1.5rem 0">
          <button class="button" onclick="showModal('createTemplateModal')">
            <i class="fas fa-plus"></i> Create New Template
          </button>
        </div>

        <button
          class="button"
          onclick="hideModal('templateManagerModal')"
          style="width: 100%; background: #6b7280"
        >
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <!-- Create Template Modal -->
    <div class="modal-backdrop" id="createTemplateModal">
      <div class="modal-content template-modal">
        <button class="close-popup" onclick="hideModal('createTemplateModal')">
          <i class="fas fa-times"></i>
        </button>
        <h2><i class="fas fa-plus"></i> Create New Template</h2>

        <div style="margin-bottom: 1.5rem">
          <div class="form-group">
            <label for="templateName">Template Name</label>
            <input
              type="text"
              id="templateName"
              placeholder="Enter template name"
            />
          </div>

          <div id="createTemplateContent" style="margin-top: 1.5rem"></div>
        </div>

        <div class="button-group">
          <button class="button" onclick="saveTemplate()">
            <i class="fas fa-save"></i> Save Template
          </button>
          <button
            class="button"
            onclick="hideModal('createTemplateModal')"
            style="background: #6b7280"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Template Modal -->
    <div class="modal-backdrop" id="editTemplateModal">
      <div class="modal-content template-modal">
        <button class="close-popup" onclick="hideModal('editTemplateModal')">
          <i class="fas fa-times"></i>
        </button>
        <h2 id="editTemplateTitle">
          <i class="fas fa-edit"></i> Edit Template
        </h2>

        <div id="editTemplateContent" style="margin-bottom: 1.5rem"></div>

        <div class="button-group">
          <button class="button" onclick="saveTemplateChanges()">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button
            class="button"
            onclick="hideModal('editTemplateModal')"
            style="background: #6b7280"
          >
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      let calendar;
      let selectedEvents = [];
      let selectedDays = new Set();
      const employees = JSON.parse(localStorage.getItem("crewEmployees")) || [];
      let hasUnsavedChanges = false;
      let currentViewHoursData = [];
      let visibleHoursCount = 0;
      let user = JSON.parse(localStorage.getItem("loggedInUser"));

      // Modal functions
      function showModal(modalId) {
        hideAllModals();
        document.getElementById(modalId).classList.add("active");
      }

      function hideModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
      }

      function hideAllModals() {
        const modals = document.querySelectorAll(".modal-backdrop");
        modals.forEach((modal) => modal.classList.remove("active"));
      }

      // Initialize application
      document.addEventListener("DOMContentLoaded", function () {
        // User authentication check
        user = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!user) {
          window.location.href = "login.html";
        }

        // Initialize calendar
        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "timeGridWeek",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek",
          },
          editable: user.role === "owner",
          selectable: user.role === "owner",
          selectMirror: true,
          dayMaxEvents: true,
          slotDuration: "00:15:00",
          slotLabelInterval: "00:15:00",
          events: JSON.parse(localStorage.getItem("scheduledShifts")) || [],
          slotMinTime: "08:00:00",
          slotMaxTime: "24:00:00",
          displayEventTime: true,
          displayEventEnd: true,
          eventTimeFormat: {
            hour: "numeric",
            minute: "2-digit",
            meridiem: "short",
          },
          views: {
            timeGridWeek: {
              dayHeaderFormat: { weekday: "long" },
              slotLabelFormat: {
                hour: "numeric",
                minute: "2-digit",
                meridiem: "short",
              },
              displayEventTime: true,
              displayEventEnd: true,
            },
            dayGridMonth: {
              dayHeaderFormat: { weekday: "short" },
              displayEventTime: true,
              displayEventEnd: true,
              eventDisplay: "block",
              eventTimeFormat: {
                hour: "numeric",
                minute: "2-digit",
                meridiem: "short",
              },
            },
          },
          eventDidMount: function (info) {
            info.el.style.display = "block";
            info.el.style.backgroundColor = info.event.backgroundColor;
            info.el.style.borderColor = info.event.borderColor;
            info.el.style.color = info.event.textColor;
          },
          eventClick: function (info) {
            if (user.role === "owner") {
              selectedDays.clear();
              calendar.getEvents().forEach((event) => {
                event.setProp("borderColor", "");
                event.setProp("borderWidth", "");
              });

              if (info.jsEvent.shiftKey) {
                selectedEvents.push(info.event);
                info.event.setProp("borderColor", "#dc2626");
                info.event.setProp("borderWidth", "2px");
              } else {
                selectedEvents.forEach((event) => {
                  event.setProp("borderColor", "");
                  event.setProp("borderWidth", "");
                });
                selectedEvents = [info.event];
                info.event.setProp("borderColor", "#dc2626");
                info.event.setProp("borderWidth", "2px");
              }
            }
          },
          select: function (info) {
            if (user.role === "owner") {
              selectedEvents.forEach((event) => {
                event.setProp("borderColor", "");
                event.setProp("borderWidth", "");
              });
              selectedEvents = [];
              selectedDays.clear();

              const startDate = new Date(info.start);
              const endDate = new Date(info.end);
              endDate.setDate(endDate.getDate() - 1);
              for (
                let d = new Date(startDate);
                d <= endDate;
                d.setDate(d.getDate() + 1)
              ) {
                selectedDays.add(d.toDateString());
              }

              // Highlight all events on selected days
              calendar.getEvents().forEach((event) => {
                const eventDate = event.start.toDateString();
                if (selectedDays.has(eventDate)) {
                  event.setProp("borderColor", "#dc2626");
                  event.setProp("borderWidth", "2px");
                }
              });
            }
          },
          dateClick: function (info) {
            if (user.role === "owner") {
              const clickedDate = info.date.toDateString();

              // Clear previous selection
              selectedEvents.forEach((event) => {
                event.setProp("borderColor", "");
                event.setProp("borderWidth", "");
              });
              selectedEvents = [];
              selectedDays.clear();
              selectedDays.add(clickedDate);

              // Highlight all events on selected days
              calendar.getEvents().forEach((event) => {
                const eventDate = event.start.toDateString();
                if (selectedDays.has(eventDate)) {
                  event.setProp("borderColor", "#dc2626");
                  event.setProp("borderWidth", "2px");
                }
              });
            }
          },
          eventDrop: function (info) {
            updateEventTitle(info.event);
            hasUnsavedChanges = true;
            showWeeklyHours();
          },
          eventResize: function (info) {
            updateEventTitle(info.event);
            hasUnsavedChanges = true;
            showWeeklyHours();
          },
        });
        calendar.render();

        // Add datesSet event listener
        calendar.on("datesSet", function (info) {
          showWeeklyHours();
        });

        // Add click handler for the calendar background to clear selection
        calendarEl.addEventListener("click", function (e) {
          if (
            e.target === calendarEl ||
            e.target.classList.contains("fc-view")
          ) {
            selectedEvents.forEach((event) => {
              event.setProp("borderColor", "");
              event.setProp("borderWidth", "");
            });
            selectedEvents = [];
            selectedDays.clear();
          }
        });

        // Show/hide edit controls based on user role
        const editControls = document.querySelectorAll(
          ".button:not(.view-only)"
        );
        editControls.forEach((control) => {
          control.style.display = user.role === "owner" ? "" : "none";
        });

        // Initialize employee dropdown
        populateEmployeeDropdown();

        // Show initial hours
        showWeeklyHours();

        // Save changes when leaving page
        window.addEventListener("beforeunload", function (e) {
          if (hasUnsavedChanges) {
            saveEventsToLocalStorage();
          }
        });

        // Initialize dark mode and balls if settings exist
        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark");
          document.getElementById("darkModeToggle").checked = true;
        }

        if (localStorage.getItem("ballsEnabled") === "false") {
          document.getElementById("ballContainer").style.display = "none";
          document.getElementById("ballsToggle").checked = false;
        } else {
          document.getElementById("ballsToggle").checked = true;
        }

        // Initialize template manager
        initializeTemplateManager();
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (user.role !== "owner" || !calendar) return;

        switch (e.key) {
          case "d":
            if (selectedEvents.length > 0) {
              selectedEvents.forEach((event) => {
                const newEvent = calendar.addEvent({
                  title: event.title,
                  start: new Date(event.start),
                  end: new Date(event.end),
                  backgroundColor: event.backgroundColor,
                  borderColor: event.borderColor,
                  textColor: event.textColor,
                  display: "block",
                });
                event.setProp("borderColor", "");
                newEvent.setProp("borderColor", "#dc2626");
                newEvent.setProp("borderWidth", "2px");
              });
              hasUnsavedChanges = true;
              showWeeklyHours();
              showSuccessMessage("Shift(s) duplicated successfully!");
            }
            break;
          case "Backspace":
          case "Delete":
            if (selectedDays.size > 0) {
              // Get all events on selected days
              const eventsToDelete = calendar.getEvents().filter((event) => {
                const eventDate = event.start.toDateString();
                return selectedDays.has(eventDate);
              });

              if (eventsToDelete.length > 0) {
                const message = `Are you sure you want to delete all ${eventsToDelete.length} shifts?`;
                if (confirm(message)) {
                  eventsToDelete.forEach((event) => event.remove());
                  selectedDays.clear();
                  hasUnsavedChanges = true;
                  showWeeklyHours();
                  showSuccessMessage(`Deleted ${eventsToDelete.length} shifts`);
                }
              } else {
                showErrorMessage("No shifts found on selected days");
              }
            } else if (selectedEvents.length > 0) {
              const message =
                selectedEvents.length === 1
                  ? "Are you sure you want to delete this shift?"
                  : `Are you sure you want to delete ${selectedEvents.length} shifts?`;

              if (confirm(message)) {
                selectedEvents.forEach((event) => event.remove());
                selectedEvents = [];
                hasUnsavedChanges = true;
                showWeeklyHours();
                showSuccessMessage(`Deleted ${selectedEvents.length} shifts`);
              }
            } else {
              showErrorMessage("No days or shifts selected");
            }
            break;
          case "r":
            if (selectedEvents.length === 1) {
              showReassignModal();
            } else if (selectedEvents.length > 1) {
              showErrorMessage("Can only reassign one shift at a time");
            }
            break;
        }
      });

      function showReassignModal() {
        const currentEmployee = selectedEvents[0].title.split(" (")[0];
        const availableEmployees = employees.filter(
          (emp) => emp.name !== currentEmployee
        );

        const modalContent = `
        <div class="modal-content">
          <button class="close-popup" onclick="hideModal('reassignModal')">
            <i class="fas fa-times"></i>
          </button>
          <h2>Reassign Shift</h2>
          <div style="margin-bottom: 1.5rem">
            <label for="reassignEmpSelect">Select Employee</label>
            <select id="reassignEmpSelect" class="select">
              <option value="">Select Employee</option>
              ${availableEmployees
                .map(
                  (emp) => `<option value="${emp.name}">${emp.name}</option>`
                )
                .join("")}
            </select>
          </div>
          <div class="button-group">
            <button class="button" onclick="confirmReassign()">
              Reassign
            </button>
            <button class="button" onclick="hideModal('reassignModal')" style="background: #6b7280">
              Cancel
            </button>
          </div>
        </div>
      `;

        // Create modal container
        const modal = document.createElement("div");
        modal.id = "reassignModal";
        modal.className = "modal-backdrop active";
        modal.innerHTML = modalContent;
        document.body.appendChild(modal);
      }

      function confirmReassign() {
        const selectedEmployee =
          document.getElementById("reassignEmpSelect").value;
        if (!selectedEmployee) {
          alert("Please select an employee.");
          return;
        }

        const currentTitle = selectedEvents[0].title;
        const newTitle = currentTitle.replace(
          currentTitle.split(" (")[0],
          selectedEmployee
        );

        selectedEvents[0].setProp("title", newTitle);
        hasUnsavedChanges = true;
        showWeeklyHours();
        hideModal("reassignModal");
        showSuccessMessage("Shift reassigned successfully!");
      }

      function formatDate(date) {
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      // Show weekly hours
      function showWeeklyHours() {
        if (!calendar) return;

        const view = calendar.view;
        const viewType = view.type;

        // Use currentStart/currentEnd for period calculations
        const periodStart = new Date(view.currentStart);
        const periodEnd = new Date(view.currentEnd);

        // Update section title based on view
        const hoursTitle = document.getElementById("hoursTitle");
        hoursTitle.textContent =
          viewType === "dayGridMonth" ? "Monthly Hours" : "Weekly Hours";

        // Format period display
        const periodElement = document.getElementById("hoursPeriod");
        if (viewType === "dayGridMonth") {
          periodElement.textContent = periodStart.toLocaleString("default", {
            month: "long",
            year: "numeric",
          });
        } else {
          const weekEnd = new Date(periodEnd);
          weekEnd.setDate(weekEnd.getDate() - 1); // Adjust to last day of week
          periodElement.textContent = `${formatDate(
            periodStart
          )} - ${formatDate(weekEnd)}`;
        }

        // Calculate hours for events in the current view period
        const events = calendar
          .getEvents()
          .filter(
            (event) => event.start >= periodStart && event.start < periodEnd
          );

        const hoursPerPerson = {};
        let totalHours = 0;

        events.forEach((event) => {
          const nameMatch = event.title.match(/^(.+?) \(/);
          if (!nameMatch) return;
          const name = nameMatch[1];
          const duration = (event.end - event.start) / (1000 * 60 * 60);

          if (!hoursPerPerson[name]) hoursPerPerson[name] = 0;
          hoursPerPerson[name] += duration;
          totalHours += duration;
        });

        // Update total hours display
        document.getElementById(
          "hoursTotal"
        ).textContent = `Total: ${totalHours.toFixed(1)} hours`;

        // Store view data
        currentViewHoursData = Object.entries(hoursPerPerson).map(
          ([name, hours]) => ({
            name,
            hours: hours.toFixed(1),
          })
        );

        // Filter hours list
        filterHoursList();
      }

      // Filter hours list by name
      function filterHoursList() {
        const searchText = (
          document.getElementById("hoursSearchInput").value || ""
        ).toLowerCase();

        // Sort first, then filter
        const filteredData = currentViewHoursData
          .filter((employee) =>
            employee.name.toLowerCase().includes(searchText)
          )
          .sort((a, b) => parseFloat(b.hours) - parseFloat(a.hours)); // Descending order by hours

        const weeklyHoursList = document.getElementById("weeklyHoursList");
        const noHoursMessage = document.getElementById("noHoursMessage");

        weeklyHoursList.innerHTML = "";
        visibleHoursCount = filteredData.length;

        if (filteredData.length === 0) {
          noHoursMessage.style.display = "block";
        } else {
          noHoursMessage.style.display = "none";
          filteredData.forEach(({ name, hours }) => {
            const li = document.createElement("li");
            li.innerHTML = `
        <span>${name}</span>
        <span>${hours} hours</span>
      `;
            weeklyHoursList.appendChild(li);
          });
        }

        // Update hours count display
        updateHoursCount();
      }

      // Update hours count display
      function updateHoursCount() {
        document.getElementById(
          "hoursCount"
        ).textContent = `Showing ${visibleHoursCount} employee${
          visibleHoursCount !== 1 ? "s" : ""
        }`;
      }

      // Update event title
      function updateEventTitle(event) {
        const duration = (event.end - event.start) / (1000 * 60 * 60);
        const titleParts = event.title.split(" (");
        const newTitle = `${titleParts[0]} (${duration.toFixed(1)}h)`;
        event.setProp("title", newTitle);
      }

      // Populate employee dropdown
      function populateEmployeeDropdown() {
        const select = document.getElementById("assignEmpSelect");
        select.innerHTML = '<option value="">Select Employee</option>';

        employees.forEach((emp) => {
          const option = document.createElement("option");
          option.value = emp.name;
          option.textContent = emp.name;
          select.appendChild(option);
        });
      }

      // Assign shift
      function assignShift() {
        const employee = document.getElementById("assignEmpSelect").value;
        if (!employee) {
          alert("Please select an employee.");
          return;
        }

        // Get the selected date or use today
        let selectedDate = calendar.getDate();
        if (selectedEvents.length > 0) {
          selectedDate = selectedEvents[0].start;
        } else if (selectedDays.size > 0) {
          // Use the first selected day
          selectedDate = new Date(Array.from(selectedDays)[0]);
        }

        // Set time to 9:45 AM on the selected date
        const startTime = new Date(selectedDate);
        startTime.setHours(9, 45, 0, 0);

        const endTime = new Date(startTime);
        endTime.setHours(endTime.getHours() + 5); // Add 5 hours for shift duration

        // If end time is on a different day, adjust it to end at 23:59
        if (endTime.getDate() !== startTime.getDate()) {
          endTime.setDate(startTime.getDate());
          endTime.setHours(23, 59, 0, 0);
        }

        // Get employee details
        const emp = employees.find((e) => e.name === employee);

        if (!emp) {
          alert("Selected employee not found in the system.");
          return;
        }

        // Calculate actual duration in hours
        const shiftDuration = (endTime - startTime) / (1000 * 60 * 60);

        try {
          // Create the event
          const event = calendar.addEvent({
            title: `${emp.name} (Open - ${shiftDuration.toFixed(1)}h)`,
            start: startTime,
            end: endTime,
            allDay: false,
            backgroundColor: getShiftColor("Open"),
            borderColor: getShiftColor("Open"),
            textColor: "#ffffff",
            display: "block",
          });

          // Save to localStorage
          saveEventsToLocalStorage();

          // Clear the employee select
          document.getElementById("assignEmpSelect").value = "";

          // Update weekly hours
          showWeeklyHours();
          hasUnsavedChanges = true;
          showSuccessMessage("Shift assigned successfully!");

          // Force calendar to re-render
          calendar.render();
        } catch (error) {
          console.error("Error adding event:", error);
          alert("Error creating shift. Please try again.");
        }
      }

      // Save events to localStorage
      function saveEventsToLocalStorage() {
        const events = calendar.getEvents().map((event) => ({
          title: event.title,
          start: event.start,
          end: event.end,
          allDay: event.allDay,
          backgroundColor: event.backgroundColor,
          borderColor: event.borderColor,
          textColor: event.textColor,
          display: "block",
        }));
        localStorage.setItem("scheduledShifts", JSON.stringify(events));
      }

      // Get shift color
      function getShiftColor(shiftType) {
        switch (shiftType) {
          case "Open":
            return "#4CAF50"; // Green
          case "Close":
            return "#F44336"; // Red
          case "Floor":
            return "#2196F3"; // Blue
          default:
            return "#9E9E9E"; // Grey
        }
      }

      // Generate schedule
      function generateSchedule() {
        const templates =
          JSON.parse(localStorage.getItem("scheduleTemplates")) || {};
        const selectedTemplate =
          localStorage.getItem("selectedTemplate") || null;

        if (employees.length === 0) {
          showErrorMessage("No employees available to assign shifts");
          return;
        }

        // Find the first unscheduled week
        const today = new Date();
        let currentWeekStart = new Date(today);
        currentWeekStart.setDate(today.getDate() - today.getDay());
        currentWeekStart.setHours(0, 0, 0, 0);

        const existingEvents = calendar.getEvents();
        while (true) {
          const weekEnd = new Date(currentWeekStart);
          weekEnd.setDate(currentWeekStart.getDate() + 6);
          weekEnd.setHours(23, 59, 59, 999);

          const weekShifts = existingEvents.filter((event) => {
            const date = new Date(event.start);
            return date >= currentWeekStart && date <= weekEnd;
          });

          if (weekShifts.length === 0) break;
          currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        }

        // Initialize employee hour tracker
        const hoursMap = {};
        const dailyAssignments = {};
        employees.forEach((emp) => (hoursMap[emp.name] = 0));

        existingEvents.forEach((event) => {
          const start = new Date(event.start);
          const end = new Date(event.end);
          const dateKey = start.toDateString();
          const match = event.title.match(/^(.+?) \(/);
          if (!match) return;
          const name = match[1];
          const hours = (end - start) / (1000 * 60 * 60);
          hoursMap[name] = (hoursMap[name] || 0) + hours;
          if (!dailyAssignments[dateKey]) dailyAssignments[dateKey] = new Set();
          dailyAssignments[dateKey].add(name);
        });

        if (selectedTemplate && templates[selectedTemplate]) {
          const template = templates[selectedTemplate];

          for (let i = 0; i < 7; i++) {
            const currentDate = new Date(currentWeekStart);
            currentDate.setDate(currentWeekStart.getDate() + i);
            const dateKey = currentDate.toDateString();
            const dayName = currentDate
              .toLocaleDateString("en-US", { weekday: "long" })
              .toLowerCase();

            if (!template.days[dayName] || !template.days[dayName].enabled)
              continue;

            template.days[dayName].shifts.forEach((shift) => {
              const startTime = new Date(currentDate);
              const [sh, sm] = shift.startTime.split(":");
              startTime.setHours(parseInt(sh), parseInt(sm));

              const endTime = new Date(currentDate);
              const [eh, em] = shift.endTime.split(":");
              endTime.setHours(parseInt(eh), parseInt(em));

              const duration = (endTime - startTime) / (1000 * 60 * 60);

              // Filter available employees
              let available = employees.filter((emp) => {
                if (
                  (shift.type === "Open" || shift.type === "Close") &&
                  !emp.isKeyholder
                )
                  return false;
                if (dailyAssignments[dateKey]?.has(emp.name)) return false;
                return true;
              });

              if (available.length === 0) return;

              // Sort by least hours assigned
              available.sort(
                (a, b) => (hoursMap[a.name] || 0) - (hoursMap[b.name] || 0)
              );

              const chosen = available[0];
              hoursMap[chosen.name] += duration;
              if (!dailyAssignments[dateKey])
                dailyAssignments[dateKey] = new Set();
              dailyAssignments[dateKey].add(chosen.name);

              calendar.addEvent({
                title: `${chosen.name} (${shift.type} - ${duration.toFixed(
                  1
                )}h)`,
                start: startTime,
                end: endTime,
                allDay: false,
                backgroundColor: getShiftColor(shift.type),
                borderColor: getShiftColor(shift.type),
                textColor: "#fff",
                display: "block",
              });
            });
          }
        } else {
          // Fallback to one opener shift per weekday
          for (let i = 0; i < 5; i++) {
            const currentDate = new Date(currentWeekStart);
            currentDate.setDate(currentWeekStart.getDate() + i);
            const dateKey = currentDate.toDateString();

            let available = employees.filter(
              (emp) =>
                emp.isKeyholder && !dailyAssignments[dateKey]?.has(emp.name)
            );

            if (available.length === 0) continue;

            available.sort(
              (a, b) => (hoursMap[a.name] || 0) - (hoursMap[b.name] || 0)
            );
            const chosen = available[0];

            const start = new Date(currentDate);
            start.setHours(9, 45, 0, 0);
            const end = new Date(start);
            end.setHours(end.getHours() + 5);

            const duration = 5;
            hoursMap[chosen.name] += duration;
            if (!dailyAssignments[dateKey])
              dailyAssignments[dateKey] = new Set();
            dailyAssignments[dateKey].add(chosen.name);

            calendar.addEvent({
              title: `${chosen.name} (Open - 5.0h)`,
              start,
              end,
              allDay: false,
              backgroundColor: getShiftColor("Open"),
              borderColor: getShiftColor("Open"),
              textColor: "#fff",
              display: "block",
            });
          }
        }

        saveEventsToLocalStorage();
        showSuccessMessage("Schedule generated successfully");
        showWeeklyHours();
        hasUnsavedChanges = true;
      }

      // Utility functions
      function showSuccessMessage(message) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "success-message";
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 3000);
      }

      function showErrorMessage(message) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "error-message";
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 3000);
      }

      // Settings functions
      function toggleSettings() {
        document.getElementById("settingsPanel").classList.toggle("active");
      }

      function toggleTheme() {
        document.body.classList.toggle("dark");
        localStorage.setItem(
          "darkMode",
          document.body.classList.contains("dark")
        );
      }

      function toggleBalls() {
        const enabled = document.getElementById("ballsToggle").checked;
        localStorage.setItem("ballsEnabled", enabled);
        document.getElementById("ballContainer").style.display = enabled
          ? "block"
          : "none";
      }

      function logout() {
        localStorage.removeItem("loggedInUser");
        window.location.href = "login.html";
      }

      // Template Manager Functions
      function initializeTemplateManager() {
        const templates =
          JSON.parse(localStorage.getItem("scheduleTemplates")) || {};
        const templateSelect = document.getElementById("templateSelect");

        templateSelect.innerHTML =
          '<option value="">Select a template</option>';

        for (const name in templates) {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          templateSelect.appendChild(option);
        }

        populateCreateTemplateDays();
      }

      function populateCreateTemplateDays() {
        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];
        const container = document.getElementById("createTemplateContent");
        container.innerHTML = "";

        days.forEach((day) => {
          const capitalized = day.charAt(0).toUpperCase() + day.slice(1);

          const dayHTML = `
          <div class="day-row">
            <div class="day-header">
              <input type="checkbox" id="${day}-enabled" checked>
              <label for="${day}-enabled">${capitalized}</label>
            </div>
            
            <div class="shifts-container" id="${day}-shifts">
              <div class="shift-row">
                <input type="time" class="shift-time" value="09:45">
                <input type="time" class="shift-time" value="14:45">
                <select class="shift-type">
                  <option value="Open">Open</option>
                  <option value="Floor">Floor</option>
                  <option value="Close">Close</option>
                </select>
                <button class="button small" onclick="addShift(this)">+</button>
                <button class="button small delete" onclick="removeShift(this)">-</button>
              </div>
            </div>
          </div>
        `;

          container.innerHTML += dayHTML;
        });
      }

      function openEditTemplateModal() {
        const templateSelect = document.getElementById("templateSelect");
        const templateName = templateSelect.value;

        if (!templateName) {
          alert("Please select a template to edit.");
          return;
        }

        const templates =
          JSON.parse(localStorage.getItem("scheduleTemplates")) || {};
        const template = templates[templateName];

        if (!template) {
          alert("Template not found.");
          return;
        }

        document.getElementById("editTemplateModal").dataset.templateName =
          templateName;

        document.getElementById(
          "editTemplateTitle"
        ).innerHTML = `<i class="fas fa-edit"></i> Edit Template: ${templateName}`;

        // Populate template content
        const container = document.getElementById("editTemplateContent");
        container.innerHTML = "";

        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];

        days.forEach((day) => {
          const capitalized = day.charAt(0).toUpperCase() + day.slice(1);
          const dayData = template.days[day] || { enabled: false, shifts: [] };

          let shiftsHTML = "";

          if (dayData.shifts.length > 0) {
            dayData.shifts.forEach((shift) => {
              shiftsHTML += `
              <div class="shift-row">
                <input type="time" class="shift-time" value="${
                  shift.startTime
                }">
                <input type="time" class="shift-time" value="${shift.endTime}">
                <select class="shift-type">
                  <option value="Open" ${
                    shift.type === "Open" ? "selected" : ""
                  }>Open</option>
                  <option value="Floor" ${
                    shift.type === "Floor" ? "selected" : ""
                  }>Floor</option>
                  <option value="Close" ${
                    shift.type === "Close" ? "selected" : ""
                  }>Close</option>
                </select>
                <button class="button small" onclick="addShift(this)">+</button>
                <button class="button small delete" onclick="removeShift(this)">-</button>
              </div>
            `;
            });
          } else {
            shiftsHTML = `
            <div class="shift-row">
              <input type="time" class="shift-time" value="09:45">
              <input type="time" class="shift-time" value="14:45">
              <select class="shift-type">
                <option value="Open">Open</option>
                <option value="Floor">Floor</option>
                <option value="Close">Close</option>
              </select>
              <button class="button small" onclick="addShift(this)">+</button>
              <button class="button small delete" onclick="removeShift(this)">-</button>
            </div>
          `;
          }

          const dayHTML = `
          <div class="day-row">
            <div class="day-header">
              <input type="checkbox" id="edit-${day}-enabled" ${
            dayData.enabled ? "checked" : ""
          }>
              <label for="edit-${day}-enabled">${capitalized}</label>
            </div>
            
            <div class="shifts-container" id="edit-${day}-shifts">
              ${shiftsHTML}
            </div>
          </div>
        `;

          container.innerHTML += dayHTML;
        });

        showModal("editTemplateModal");
      }

      function saveTemplate() {
        const templateName = document
          .getElementById("templateName")
          .value.trim();

        if (!templateName) {
          showErrorMessage("Please enter a template name");
          return;
        }

        const templates =
          JSON.parse(localStorage.getItem("scheduleTemplates")) || {};

        if (templates[templateName]) {
          showErrorMessage("Template name already exists");
          return;
        }

        // Create new template
        const template = { name: templateName, days: {} };
        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];

        days.forEach((day) => {
          const enabled = document.getElementById(`${day}-enabled`).checked;
          const shifts = [];

          const shiftContainer = document.getElementById(`${day}-shifts`);
          const shiftRows = shiftContainer.querySelectorAll(".shift-row");

          shiftRows.forEach((row) => {
            const times = row.querySelectorAll(".shift-time");
            const typeSelect = row.querySelector(".shift-type");

            shifts.push({
              startTime: times[0].value,
              endTime: times[1].value,
              type: typeSelect.value,
            });
          });

          template.days[day] = { enabled, shifts };
        });

        // Save template
        templates[templateName] = template;
        localStorage.setItem("scheduleTemplates", JSON.stringify(templates));

        // Update UI
        initializeTemplateManager();
        hideModal("createTemplateModal");
        showSuccessMessage("Template saved successfully!");
      }

      function saveTemplateChanges() {
        const templateTitle =
          document.getElementById("editTemplateTitle").textContent;
        const templateName =
          document.getElementById("editTemplateModal").dataset.templateName;

        if (!templateName) {
          showErrorMessage("Error: Template not found");
          return;
        }

        const templates =
          JSON.parse(localStorage.getItem("scheduleTemplates")) || {};
        const template = templates[templateName];

        if (!template) {
          showErrorMessage("Template not found");
          return;
        }

        // Update template
        const days = [
          "monday",
          "tuesday",
          "wednesday",
          "thursday",
          "friday",
          "saturday",
          "sunday",
        ];

        days.forEach((day) => {
          const enabled = document.getElementById(
            `edit-${day}-enabled`
          ).checked;
          const shifts = [];

          const shiftContainer = document.getElementById(`edit-${day}-shifts`);
          const shiftRows = shiftContainer.querySelectorAll(".shift-row");

          shiftRows.forEach((row) => {
            const times = row.querySelectorAll(".shift-time");
            const typeSelect = row.querySelector(".shift-type");

            shifts.push({
              startTime: times[0].value,
              endTime: times[1].value,
              type: typeSelect.value,
            });
          });

          template.days[day] = { enabled, shifts };
        });

        // Save template
        templates[templateName] = template;
        localStorage.setItem("scheduleTemplates", JSON.stringify(templates));

        // Update UI
        initializeTemplateManager();
        hideModal("editTemplateModal");
        showSuccessMessage("Template updated successfully!");
      }

      function loadTemplate() {
        const templateSelect = document.getElementById("templateSelect");
        const templateName = templateSelect.value;

        if (!templateName) {
          showErrorMessage("Please select a template");
          return;
        }

        localStorage.setItem("selectedTemplate", templateName);
        hideModal("templateManagerModal");
        showSuccessMessage("Template selected for schedule generation!");
      }

      function deleteTemplate() {
        const templateSelect = document.getElementById("templateSelect");
        const templateName = templateSelect.value;

        if (!templateName) {
          showErrorMessage("Please select a template to delete");
          return;
        }

        if (
          !confirm(
            `Are you sure you want to delete the "${templateName}" template?`
          )
        ) {
          return;
        }

        const templates =
          JSON.parse(localStorage.getItem("scheduleTemplates")) || {};
        delete templates[templateName];
        localStorage.setItem("scheduleTemplates", JSON.stringify(templates));

        // Clear selected template if it was this one
        if (localStorage.getItem("selectedTemplate") === templateName) {
          localStorage.removeItem("selectedTemplate");
        }

        // Update UI
        initializeTemplateManager();
        hideModal("templateManagerModal");
        showSuccessMessage("Template deleted successfully!");
      }

      // Shift row management
      function addShift(btn) {
        const shiftRow = btn.closest(".shift-row");
        const newRow = shiftRow.cloneNode(true);

        // Clear input values
        newRow.querySelectorAll("input").forEach((input) => (input.value = ""));
        newRow.querySelector("select").selectedIndex = 0;

        shiftRow.parentNode.appendChild(newRow);
      }

      function removeShift(btn) {
        const shiftRow = btn.closest(".shift-row");
        const container = shiftRow.parentNode;

        if (container.querySelectorAll(".shift-row").length > 1) {
          shiftRow.remove();
        } else {
          showErrorMessage("Each day must have at least one shift");
        }
      }

      function sendScheduleToWhatsApp() {
        const view = calendar.view;
        const periodStart = new Date(view.currentStart);
        const periodEnd = new Date(view.currentEnd);

        // Get events only within the current view range
        const events = calendar.getEvents().filter((event) => {
          return event.start >= periodStart && event.start < periodEnd;
        });

        let message = `*CrewPilot Schedule* (${view.title})\n\n`;

        if (events.length === 0) {
          message += "No shifts scheduled for this period.";
        } else {
          const shiftsByEmployee = {};

          events.forEach((event) => {
            const nameMatch = event.title.match(/^(.+?) \(/);
            if (!nameMatch) return;
            const name = nameMatch[1];

            const shiftDetails = event.title.match(/\((.*?)\)/)?.[1] || "";

            if (!shiftsByEmployee[name]) {
              shiftsByEmployee[name] = [];
            }

            const date = event.start.toLocaleDateString("en-US", {
              weekday: "short",
              month: "short",
              day: "numeric",
            });

            const time = `${event.start.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })}-${event.end.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })}`;

            shiftsByEmployee[name].push({
              start: event.start,
              date,
              time,
              details: shiftDetails,
            });
          });

          const sortedEmployees = Object.keys(shiftsByEmployee).sort();

          sortedEmployees.forEach((name) => {
            const shifts = shiftsByEmployee[name];

            shifts.sort((a, b) => a.start - b.start);

            message += `*${name}:*\n`;

            shifts.forEach((shift) => {
              message += `  - ${shift.date}: ${shift.time} (${shift.details})\n`;
            });

            message += "\n";
          });
        }

        const encoded = encodeURIComponent(message);
        const url = `https://wa.me/?text=${encoded}`;
        window.open(url, "_blank");
      }
    </script>
  </body>
</html>
